<!DOCTYPE html>
<html>
	<head>
		<script src="three.min.js"></script>
		<script src="human.js"></script>
	</head>
	<body>
		<h1>"Майка Валкирия"<br><small>ф.н. 81394 &ndash; група 3 &ndash; Антони Калоферов</small></h1>
		<!-- <audio id="music" autoplay loop>
				<source src="Wagner - RIDE OF THE VALKYRIES - Furtwangler-V92OBNsQgxU.mp3" type="audio/mpeg">
		</audio> -->
		<script>
			// нагласяване на цвета и центрирането на текста с имената ви
			document.getElementsByTagName('h1')[0].style = 'color:white; text-align:center; font-size:1.75em';
			
			// рисувателно поле на цял екран
			renderer = new THREE.WebGLRenderer({antialias:true});
			renderer.setSize( window.innerWidth, window.innerHeight );
			document.body.appendChild( renderer.domElement );
			renderer.domElement.style = 'width:100%; height:100%; position:fixed; top:0; left:0; z-index:-1;';
			
			// сцена и камера
			scene = new THREE.Scene();
			var sceneRotation = -Math.PI/3
			scene.rotateY(sceneRotation);
			camera = new THREE.PerspectiveCamera( 30, window.innerWidth/window.innerHeight, 0.1, 2000 );
			camera.position.set(0,55,400);
			// camera.lookAt(new THREE.Vector3(0,0,0));

			helper = new THREE.AxisHelper(1000);
			scene.add(helper);

			// светлини
			var light = new THREE.DirectionalLight('lightblue',0.8);
			light.position.set(0,1,4);
			scene.add(light);
			scene.add( new THREE.AmbientLight('white',0.4) );
			
			// функция за анимиране на сцената
			var t = 0; // време
			function drawFrame()
			{
				requestAnimationFrame( drawFrame );
				if (animate) animate(t++);
				renderer.render( scene, camera );
			}

			майка = женствен();
			дете = мъжествен();
			дете.scale.set(0.6,0.6,0.6);
			дете.position.set(100, 0, 100);
		
			// функция за плавност, вместо cos или sin
			// тя е доста подобна но не е циклична
			smoothSigmoid = function(t, step) 
			{
				return (1/(1 + Math.exp(-t/step)));
			}
			
			// променливи за движението по осморка
			var k = 0.0169;
			var m = 0.007;
			var v = new THREE.Vector3(1, 0, 0);
			var rot = 0;
			animate = function (t)
			{
				//стъпки след които главата на детето да следи майката

				//много време ми отне да постигна желания резултат тъй като моделите на
				//манекените не гледат там където всъщност гледат, а на 90 градуса от там
				//и този факт обърква всички сметки, и трябваше да правя хитрости.
				//въпреки хитростите, не постигнах това което исках тъй като има две места,
				//на които главата на детето "скача" и не можах да ги оправя
				//кода е неразбираем, дори и за мен :), но в крайна сметка почти го напаснах по "умен" начин
				//просто много исках детето да гледа към майката докато тя лети ....
				дете.lookAt(майка.position);
				дете.rotateY(-Math.PI/2);
				var headRotation = дете.getWorldRotation();

				дете.lookAt(new THREE.Vector3(0, 0, 0));
				дете.rotateOnAxis(new THREE.Vector3(0, 1, 0), -Math.PI/2);
				дете.глава.rotation.x = headRotation.x;
				дете.глава.rotation.y = headRotation.y; 
				дете.глава.rotation.z = headRotation.z;
				
				if (майка.position.x - майка.position.z >= -33.3) {
					дете.глава.rotation.y += sceneRotation;
				}else{
					дете.глава.rotation.y += -sceneRotation;
				}
				
				// за вдигане на ръцете
				if (t < 470) 
				{
					майка.д_ръка.врът(smoothSigmoid(t-200, 30)*t/20, 0, -smoothSigmoid(t-200, 30)*180);	
					майка.л_ръка.врът(smoothSigmoid(t-200, 30)*(-t/20), 0, -smoothSigmoid(t-200, 30)*180);		
				}

				// за пускане на китките
				if (t > 600 && t < 690) {
					майка.л_китка.врът(0,0,t-600);
					майка.д_китка.врът(0,0,t-600);
				}

				// за въртене на китките като хеликоптер
				if (t > 790) {
					майка.л_китка.врът(0,smoothSigmoid(t-1300, 110)*(t-790)*80,90);
					майка.д_китка.врът(0,smoothSigmoid(t-1300, 110)*(t-790)*80,90);
				}

				// за полет като истински хеликоптер + леко лющкане на краката
				if (t>1000 && t < 2500) {
					if (t > 1500) {
						майка.д_крак.врът(0,0, Math.cos(t/10));
						майка.л_крак.врът(0,0, Math.sin(t/10));
					}
					майка.position.set(0, smoothSigmoid(t-2000, 100)*100, 0);
				}
						
				// за плавно потегляне напред чрез леко накланяне като истински хеликоптер
				if (t > 2500 && t < 2620){
					prevY = майка.position.y
					майка.rotation.z = (-smoothSigmoid(t-2577, 19)* Math.PI/8);
					rot = майка.rotation.z;
					майка.position.set(smoothSigmoid(t-2620, 10)*34, prevY, 0);
				}

				// за движение по осморка + гледане напред + люшкане на краката
				// + наклон надолу като истински хеликоптер + люшкане настрани при завои
				if (t > 2620) {
					var alpha = k * Math.sin(m * (t - 2620));
					v.applyAxisAngle(new THREE.Vector3(0, 1, 0), alpha);
					var currPos = майка.position.clone();
					var futurePos = currPos.add(v);
					var lookAtVector = futurePos.clone();
					майка.lookAt(lookAtVector);
					майка.rotateY(-Math.PI/2);
					майка.rotateZ(rot);
					майка.rotateX(-20*alpha);
					майка.position.copy(futurePos);

					майка.д_крак.врът(Math.sin(t/10),0, Math.cos(t/7));
					майка.л_крак.врът(Math.cos(t/10),0, Math.sin(t/7));
				}
			}
				
		drawFrame();
		</script>
	</body>
</html>